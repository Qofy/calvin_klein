│ backend/README.md                                                                                                                                                                                                │
│                                                                                                                                                                                                                  │
│ # Backend API                                                                                                                                                                                                    │
│                                                                                                                                                                                                                  │
│ Rust backend server with Actix-web, PASETO authentication, HttpOnly cookies, and sled database.                                                                                                                  │
│                                                                                                                                                                                                                  │
│ ## Features                                                                                                                                                                                                      │
│                                                                                                                                                                                                                  │
│ - ✅ **HttpOnly Cookie Authentication** - Secure cookie-based auth with access + refresh tokens                                                                                                                   │
│ - ✅ **PASETO v4.local** - Modern, secure token format (also supports JWT HMAC fallback)                                                                                                                          │
│ - ✅ **Security Headers** - CSP, X-Frame-Options, X-Content-Type-Options, Referrer-Policy                                                                                                                         │
│ - ✅ **Token Rotation** - Automatic refresh token rotation for enhanced security                                                                                                                                  │
│ - ✅ **Argon2id Password Hashing** - Industry-standard password hashing                                                                                                                                           │
│ - ✅ **Sled Database** - Fast embedded key-value store with backup support                                                                                                                                        │
│ - ✅ **CORS Configuration** - Flexible origin rules from `.env_cors`                                                                                                                                              │
│ - ✅ **WASM Support** - Serves WebAssembly files with correct MIME types                                                                                                                                          │
│ - ✅ **SPA Fallback** - HTML5 history mode routing support                                                                                                                                                        │
│                                                                                                                                                                                                                  │
│ ## Quick Start                                                                                                                                                                                                   │
│                                                                                                                                                                                                                  │
│ ### 1. Setup Environment                                                                                                                                                                                         │
│                                                                                                                                                                                                                  │
│ ```bash                                                                                                                                                                                                          │
│ # Copy example environment file                                                                                                                                                                                  │
│ cp .env.example .env                                                                                                                                                                                             │
│                                                                                                                                                                                                                  │
│ # Edit .env with your configuration                                                                                                                                                                              │
│ # IMPORTANT: Generate a secure PASETO key                                                                                                                                                                        │
│ openssl rand -hex 32  # Use this as PASETO_V4_LOCAL_KEY_HEX                                                                                                                                                      │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ### 2. Configure CORS                                                                                                                                                                                            │
│                                                                                                                                                                                                                  │
│ ```bash                                                                                                                                                                                                          │
│ # Edit .env_cors to allow your frontend origins                                                                                                                                                                  │
│ # Development example:                                                                                                                                                                                           │
│ echo "http://localhost:5173 ALLOW ALL" >> .env_cors                                                                                                                                                              │
│ echo "http://127.0.0.1:5173 ALLOW ALL" >> .env_cors                                                                                                                                                              │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ### 3. Build and Run                                                                                                                                                                                             │
│                                                                                                                                                                                                                  │
│ ```bash                                                                                                                                                                                                          │
│ # Development                                                                                                                                                                                                    │
│ cargo run                                                                                                                                                                                                        │
│                                                                                                                                                                                                                  │
│ # Production build                                                                                                                                                                                               │
│ cargo build --release                                                                                                                                                                                            │
│ ./target/release/description_backend                                                                                                                                                                             │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ The server will start at `http://127.0.0.1:8080` (or your configured HOST:PORT).                                                                                                                                 │
│                                                                                                                                                                                                                  │
│ ## API Endpoints                                                                                                                                                                                                 │
│                                                                                                                                                                                                                  │
│ ### Health Check                                                                                                                                                                                                 │
│                                                                                                                                                                                                                  │
│ ```bash                                                                                                                                                                                                          │
│ # Check server health                                                                                                                                                                                            │
│ curl http://localhost:8080/healthz                                                                                                                                                                               │
│ # Returns: {"status":"ok","time":"2025-11-05T...","version":"0.1.0"}                                                                                                                                             │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ### Authentication                                                                                                                                                                                               │
│                                                                                                                                                                                                                  │
│ #### Register                                                                                                                                                                                                    │
│ ```bash                                                                                                                                                                                                          │
│ curl -X POST http://localhost:8080/api/auth/register \                                                                                                                                                           │
│   -H "Content-Type: application/json" \                                                                                                                                                                          │
│   -d '{"email":"user@example.com","password":"SecurePass123"}'                                                                                                                                                   │
│ # Returns 201 with HttpOnly cookies set                                                                                                                                                                          │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ #### Login                                                                                                                                                                                                       │
│ ```bash                                                                                                                                                                                                          │
│ curl -X POST http://localhost:8080/api/auth/login \                                                                                                                                                              │
│   -H "Content-Type: application/json" \                                                                                                                                                                          │
│   -d '{"email":"user@example.com","password":"SecurePass123"}' \                                                                                                                                                 │
│   -c cookies.txt                                                                                                                                                                                                 │
│ # Returns 204 with HttpOnly cookies set                                                                                                                                                                          │
│ # Cookies stored in cookies.txt for subsequent requests                                                                                                                                                          │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ #### Get Profile                                                                                                                                                                                                 │
│ ```bash                                                                                                                                                                                                          │
│ curl http://localhost:8080/api/auth/me \                                                                                                                                                                         │
│   -b cookies.txt                                                                                                                                                                                                 │
│ # Returns: {"id":"...","email":"user@example.com","roles":["user"]}                                                                                                                                              │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ #### Refresh Token                                                                                                                                                                                               │
│ ```bash                                                                                                                                                                                                          │
│ curl -X POST http://localhost:8080/api/auth/refresh \                                                                                                                                                            │
│   -b cookies.txt \                                                                                                                                                                                               │
│   -c cookies.txt                                                                                                                                                                                                 │
│ # Returns 204 with new rotated cookies                                                                                                                                                                           │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ #### Logout                                                                                                                                                                                                      │
│ ```bash                                                                                                                                                                                                          │
│ curl -X POST http://localhost:8080/api/auth/logout \                                                                                                                                                             │
│   -b cookies.txt                                                                                                                                                                                                 │
│ # Returns 204 and clears cookies                                                                                                                                                                                 │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ### Protected Routes                                                                                                                                                                                             │
│                                                                                                                                                                                                                  │
│ All API routes under `/api` (except `/api/auth/*`) require authentication via cookie or `Authorization: Bearer <token>` header.                                                                                  │
│                                                                                                                                                                                                                  │
│ ## Architecture                                                                                                                                                                                                  │
│                                                                                                                                                                                                                  │
│ ```                                                                                                                                                                                                              │
│ backend/                                                                                                                                                                                                         │
│ ├── src/                                                                                                                                                                                                         │
│ │   ├── main.rs              # Server setup and route configuration                                                                                                                                              │
│ │   ├── types.rs             # Shared type definitions                                                                                                                                                           │
│ │   ├── config.rs            # Configuration loading                                                                                                                                                             │
│ │   ├── handlers/                                                                                                                                                                                                │
│ │   │   ├── auth.rs          # Authentication endpoints                                                                                                                                                          │
│ │   │   └── cookies.rs       # Cookie management helpers                                                                                                                                                         │
│ │   ├── middleware/                                                                                                                                                                                              │
│ │   │   └── security.rs      # Security headers middleware                                                                                                                                                       │
│ │   ├── routes/                                                                                                                                                                                                  │
│ │   │   ├── health.rs        # Health check endpoint                                                                                                                                                             │
│ │   │   └── static_files.rs  # WASM and SPA fallback                                                                                                                                                             │
│ │   ├── models/                                                                                                                                                                                                  │
│ │   │   └── auth_types.rs    # Auth data models                                                                                                                                                                  │
│ │   ├── db.rs                # Database wrapper                                                                                                                                                                  │
│ │   ├── validation.rs        # Input validation                                                                                                                                                                  │
│ │   ├── backup.rs            # Database backup manager                                                                                                                                                           │
│ │   └── replicate.rs         # Optional PostgreSQL replication                                                                                                                                                   │
│ ├── .env.example             # Example environment configuration                                                                                                                                                 │
│ ├── .env_cors               # CORS rules                                                                                                                                                                         │
│ └── README.md               # This file                                                                                                                                                                          │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ## Cookie Configuration                                                                                                                                                                                          │
│                                                                                                                                                                                                                  │
│ The backend uses HttpOnly, Secure, SameSite=Strict cookies for maximum security:                                                                                                                                 │
│                                                                                                                                                                                                                  │
│ - **Access Token** (`access_token`): Short-lived (10 minutes default), used for API requests                                                                                                                     │
│ - **Refresh Token** (`refresh_token`): Long-lived (7 days), used to obtain new access tokens                                                                                                                     │
│                                                                                                                                                                                                                  │
│ ### Development vs Production                                                                                                                                                                                    │
│                                                                                                                                                                                                                  │
│ **Development** (`.env`):                                                                                                                                                                                        │
│ ```                                                                                                                                                                                                              │
│ COOKIE_SECURE=false                                                                                                                                                                                              │
│ COOKIE_DOMAIN=                                                                                                                                                                                                   │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ **Production** (`.env`):                                                                                                                                                                                         │
│ ```                                                                                                                                                                                                              │
│ COOKIE_SECURE=true                                                                                                                                                                                               │
│ COOKIE_DOMAIN=yourdomain.com                                                                                                                                                                                     │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ## Security Features                                                                                                                                                                                             │
│                                                                                                                                                                                                                  │
│ ### Password Requirements                                                                                                                                                                                        │
│ - Minimum 12 characters                                                                                                                                                                                          │
│ - At least 1 letter and 1 number                                                                                                                                                                                 │
│ - Hashed with Argon2id (configurable parameters)                                                                                                                                                                 │
│                                                                                                                                                                                                                  │
│ ### Token Security                                                                                                                                                                                               │
│ - Access tokens expire in 10 minutes (configurable)                                                                                                                                                              │
│ - Refresh tokens expire in 7 days                                                                                                                                                                                │
│ - Automatic refresh token rotation on `/auth/refresh`                                                                                                                                                            │
│ - HttpOnly cookies prevent XSS attacks                                                                                                                                                                           │
│ - SameSite=Strict prevents CSRF attacks                                                                                                                                                                          │
│                                                                                                                                                                                                                  │
│ ### Headers                                                                                                                                                                                                      │
│ All responses include security headers:                                                                                                                                                                          │
│ - `Content-Security-Policy` - Restricts resource loading                                                                                                                                                         │
│ - `X-Frame-Options: DENY` - Prevents clickjacking                                                                                                                                                                │
│ - `X-Content-Type-Options: nosniff` - Prevents MIME sniffing                                                                                                                                                     │
│ - `Referrer-Policy: same-origin` - Controls referrer information                                                                                                                                                 │
│ - `Permissions-Policy` - Disables unnecessary browser features                                                                                                                                                   │
│                                                                                                                                                                                                                  │
│ ## CLI Commands                                                                                                                                                                                                  │
│                                                                                                                                                                                                                  │
│ ### Create Admin User                                                                                                                                                                                            │
│ ```bash                                                                                                                                                                                                          │
│ cargo run -- user add-admin --email admin@example.com                                                                                                                                                            │
│ # Prompts for password (hidden input)                                                                                                                                                                            │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ### Database Backup                                                                                                                                                                                              │
│ ```bash                                                                                                                                                                                                          │
│ cargo run -- db backup --now                                                                                                                                                                                     │
│ # Creates immediate backup snapshot                                                                                                                                                                              │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ## Database                                                                                                                                                                                                      │
│                                                                                                                                                                                                                  │
│ ### Sled (Primary)                                                                                                                                                                                               │
│ Fast embedded database, stores data in `DB_PATH` directory.                                                                                                                                                      │
│                                                                                                                                                                                                                  │
│ ### Backup System                                                                                                                                                                                                │
│ - Automatic periodic backups (configurable interval)                                                                                                                                                             │
│ - Retention policy (keeps last N backups)                                                                                                                                                                        │
│ - Manual backup via CLI                                                                                                                                                                                          │
│                                                                                                                                                                                                                  │
│ ### Optional PostgreSQL Replication                                                                                                                                                                              │
│ Enable in `.env`:                                                                                                                                                                                                │
│ ```                                                                                                                                                                                                              │
│ DATABASE_URL=postgres://user:pass@host/db                                                                                                                                                                        │
│ DATABASE_SYNC_ON_OFF=on                                                                                                                                                                                          │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ## Troubleshooting                                                                                                                                                                                               │
│                                                                                                                                                                                                                  │
│ ### "Token generation error"                                                                                                                                                                                     │
│ **Cause**: Invalid or missing `PASETO_V4_LOCAL_KEY_HEX`                                                                                                                                                          │
│ **Fix**: Generate a new key with `openssl rand -hex 32` and set it in `.env`                                                                                                                                     │
│                                                                                                                                                                                                                  │
│ ### "CORS error" in browser                                                                                                                                                                                      │
│ **Cause**: Frontend origin not allowed in `.env_cors`                                                                                                                                                            │
│ **Fix**: Add your frontend URL to `.env_cors`, e.g., `http://localhost:5173 ALLOW ALL`                                                                                                                           │
│                                                                                                                                                                                                                  │
│ ### "Cookies not sent" from frontend                                                                                                                                                                             │
│ **Cause**: Missing `credentials: 'include'` in fetch or CORS misconfiguration                                                                                                                                    │
│ **Fix**: Ensure fetch uses `credentials: 'include'` and CORS allows credentials                                                                                                                                  │
│                                                                                                                                                                                                                  │
│ ### "WASM file not loading"                                                                                                                                                                                      │
│ **Cause**: Incorrect MIME type or missing symlink                                                                                                                                                                │
│ **Fix**: Ensure `./static` symlink points to `../frontend/app/dist`                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ## Development                                                                                                                                                                                                   │
│                                                                                                                                                                                                                  │
│ ### Build for Development                                                                                                                                                                                        │
│ ```bash                                                                                                                                                                                                          │
│ cargo build                                                                                                                                                                                                      │
│ cargo run                                                                                                                                                                                                        │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ### Run Tests                                                                                                                                                                                                    │
│ ```bash                                                                                                                                                                                                          │
│ cargo test                                                                                                                                                                                                       │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ### Enable Debug Logging                                                                                                                                                                                         │
│ ```bash                                                                                                                                                                                                          │
│ RUST_LOG=debug cargo run                                                                                                                                                                                         │
│ ```                                                                                                                                                                                                              │
│                                                                                                                                                                                                                  │
│ ## Production Deployment                                                                                                                                                                                         │
│                                                                                                                                                                                                                  │
│ 1. **Build optimized binary**:                                                                                                                                                                                   │
│    ```bash                                                                                                                                                                                                       │
│    cargo build --release                                                                                                                                                                                         │
│    ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                                  │
│ 2. **Set environment variables**:                                                                                                                                                                                │
│    - `COOKIE_SECURE=true`                                                                                                                                                                                        │
│    - `RUST_LOG=info`                                                                                                                                                                                             │
│    - Generate new `PASETO_V4_LOCAL_KEY_HEX`                                                                                                                                                                      │
│    - Update `COOKIE_DOMAIN` to your domain                                                                                                                                                                       │
│                                                                                                                                                                                                                  │
│ 3. **Configure CORS**:                                                                                                                                                                                           │
│    - Update `.env_cors` with production origins                                                                                                                                                                  │
│    - Remove development origins                                                                                                                                                                                  │
│                                                                                                                                                                                                                  │
│ 4. **Enable HSTS** (uncomment in `middleware/security.rs`):                                                                                                                                                      │
│    ```rust                                                                                                                                                                                                       │
│    headers.insert(                                                                                                                                                                                               │
│        "strict-transport-security",                                                                                                                                                                              │
│        "max-age=31536000; includeSubDomains; preload"                                                                                                                                                            │
│    );                                                                                                                                                                                                            │
│    ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                                  │
│ 5. **Setup reverse proxy** (nginx example):                                                                                                                                                                      │
│    ```nginx                                                                                                                                                                                                      │
│    server {                                                                                                                                                                                                      │
│        listen 443 ssl http2;                                                                                                                                                                                     │
│        server_name api.yourdomain.com;                                                                                                                                                                           │
│                                                                                                                                                                                                                  │
│        ssl_certificate /path/to/cert.pem;                                                                                                                                                                        │
│        ssl_certificate_key /path/to/key.pem;                                                                                                                                                                     │
│                                                                                                                                                                                                                  │
│        location / {                                                                                                                                                                                              │
│            proxy_pass http://127.0.0.1:8080;                                                                                                                                                                     │
│            proxy_set_header Host $host;                                                                                                                                                                          │
│            proxy_set_header X-Real-IP $remote_addr;                                                                                                                                                              │
│            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;                                                                                                                                          │
│            proxy_set_header X-Forwarded-Proto $scheme;                                                                                                                                                           │
│        }                                                                                                                                                                                                         │
│    }                                                                                                                                                                                                             │
│    ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                                  │
│ 6. **Run as systemd service**:                                                                                                                                                                                   │
│    ```ini                                                                                                                                                                                                        │
│    [Unit]                                                                                                                                                                                                        │
│    Description=Backend API Server                                                                                                                                                                                │
│    After=network.target                                                                                                                                                                                          │
│                                                                                                                                                                                                                  │
│    [Service]                                                                                                                                                                                                     │
│    Type=simple                                                                                                                                                                                                   │
│    User=www-data                                                                                                                                                                                                 │
│    WorkingDirectory=/var/www/backend                                                                                                                                                                             │
│    Environment="PATH=/usr/local/bin:/usr/bin:/bin"                                                                                                                                                               │
│    EnvironmentFile=/var/www/backend/.env                                                                                                                                                                         │
│    ExecStart=/var/www/backend/target/release/description_backend                                                                                                                                                 │
│    Restart=always                                                                                                                                                                                                │
│                                                                                                                                                                                                                  │
│    [Install]                                                                                                                                                                                                     │
│    WantedBy=multi-user.target                                                                                                                                                                                    │
│    ```                                                                                                                                                                                                           │
│                                                                                                                                                                                                                  │
│ ## License                                                                                                                                                                                                       │
│                                                                                                                                                                                                                  │
│ Private                                                                                                                                                                                                          │
│                                                                                                                                                                                                                  │
│ ## Authors                                                                                                                                                                                                       │
│                                                                                                                                                                                                                  │
│ Your Name <you@example.com>
